# go-emby2openlist 使用指南

本文档提供 go-emby2openlist 的完整使用指南,从零开始带你搭建网盘直链反向代理服务。

## 目录

- [快速开始](#快速开始)
- [详细配置说明](#详细配置说明)
- [功能使用指南](#功能使用指南)
- [常见问题](#常见问题)
- [进阶用法](#进阶用法)
- [故障排查](#故障排查)

---

## 快速开始

### 前置条件

在开始之前,请确保你已经具备:

1. ✅ **Linux 服务器** (或 Windows/Mac,本文以 Linux 为例)
2. ✅ **Docker 和 Docker Compose** 已安装
3. ✅ **Emby 服务器** 已搭建并正常运行
4. ✅ **Openlist 服务** 已搭建并能访问网盘
5. ✅ **网盘挂载服务** (如 rclone 或 CloudDrive2)

### 架构概览

```
┌──────────────┐
│  Emby 客户端  │
└──────┬───────┘
       │
       ↓ (访问反代地址)
┌──────────────────┐
│ go-emby2openlist │ ← 你要部署的服务
└──────┬───────────┘
       │
       ├─→ Emby 源服务器 (获取元数据)
       ├─→ Openlist (获取直链)
       └─→ 网盘 (302 重定向给客户端)
```

### 5 分钟快速部署

#### 第 1 步: 获取项目

```bash
# 创建工作目录
mkdir -p ~/go-emby2openlist
cd ~/go-emby2openlist

# 下载配置文件模板
wget https://raw.githubusercontent.com/AmbitiousJun/go-emby2openlist/v2.3.2/config-example.yml -O config.yml

# 下载 docker-compose 文件
wget https://raw.githubusercontent.com/AmbitiousJun/go-emby2openlist/v2.3.2/docker-compose.yml
```

**如果使用 Git (推荐,便于更新)**:

```bash
git clone --branch v2.3.2 --depth 1 https://github.com/AmbitiousJun/go-emby2openlist
cd go-emby2openlist
cp config-example.yml config.yml
```

#### 第 2 步: 修改配置

编辑 `config.yml`,修改以下**核心配置**:

```yaml
# Emby 服务器配置
emby:
  host: http://192.168.1.100:8096    # 改为你的 Emby 源地址
  mount-path: /data                  # 改为 Emby 容器内的挂载路径

# Openlist 配置
openlist:
  host: http://192.168.1.100:5244    # 改为你的 Openlist 地址
  token: openlist-xxxxxxxxxxxxx      # 改为你的 Openlist Token

# 路径映射 (重要!)
path:
  emby2openlist:
    - /data/movie:/电影               # Emby路径:Openlist路径
    - /data/series:/电视剧
```

**如何查看 Openlist Token?**

登录 Openlist 管理后台 → 设置 → 令牌 → 复制 Token

**如何确定路径映射?**

1. 在 Emby 中查看一个视频的详细信息,记下路径 (如 `/data/movie/xxx.mkv`)
2. 在 Openlist 中找到这个文件,记下路径 (如 `/电影/xxx.mkv`)
3. 提取前缀: `/data/movie` 对应 `/电影`

#### 第 3 步: 启动服务

```bash
docker-compose up -d
```

#### 第 4 步: 验证运行

查看日志:

```bash
docker logs -f go-emby2openlist -n 100
```

正常运行的日志:

```
[GIN] 正在初始化路由规则...
[GIN] 正在启动 HTTP 服务, 端口: 8095
[GIN] 正在启动 HTTPS 服务, 端口: 8094
```

#### 第 5 步: 配置客户端

在 Emby 客户端中,将服务器地址改为:

```
http://你的服务器IP:8095
```

**测试播放**:

随便点开一个视频,如果能正常播放,说明配置成功!

---

## 详细配置说明

### Emby 配置 (`emby`)

```yaml
emby:
  # Emby 源服务器地址 (必填)
  # 格式: http://IP:端口 或 https://域名
  host: http://192.168.1.100:8096

  # Emby 容器内的挂载根路径 (必填)
  # 注意: 这里填的是容器内路径,不是宿主机路径!
  # 如何查看: 在 Emby 后台查看媒体库路径
  mount-path: /data

  # 是否让未播放的剧集排在前面 (可选, 默认 true)
  # 启用后,剧集列表会自动调整,未看的排在前面
  episodes-unplay-prior: true

  # 是否重新排序随机列表 (可选, 默认 true)
  # 启用后,随机列表会更加随机
  resort-random-items: true

  # 代理异常处理策略 (可选, 默认 origin)
  # origin: 出错时回源到 Emby 服务器处理
  # reject: 直接拒绝请求,返回错误
  proxy-error-strategy: origin

  # 图片质量 (可选, 范围 1-100, 默认 100)
  # 如果发现海报图片过大,可以降低这个值到 70-90
  images-quality: 100

  # 下载接口处理策略 (可选, 默认 403)
  # 403: 禁用下载 (推荐)
  # origin: 代理到源服务器
  # direct: 重定向到网盘直链
  download-strategy: 403

  # 本地媒体根目录 (可选)
  # 如果你有部分媒体存储在本地 (非网盘), 配置此项
  # 检测到该路径前缀的媒体会直接代理回源
  local-media-root: /data/local
```

#### Strm 文件配置

如果你使用 Strm 文件:

```yaml
emby:
  strm:
    # 路径映射 (可选)
    # 将 strm 文件内的地址替换成指定地址
    # 格式: 原地址片段 => 新地址片段
    path-map:
      - https://old-domain.com:8094 => http://localhost:8095
      - 12138 => 10086

    # 是否启用内部重定向 (可选, 默认 false)
    # 启用: 程序先访问 strm 地址,再重定向给客户端
    # 禁用: 直接将 strm 地址重定向给客户端
    internal-redirect-enable: false
```

#### 媒体库统计自定义

可以自定义 Emby 首页显示的媒体数量:

```yaml
emby:
  items-counts:
    enable: true
    mode: custom  # origin/custom/modify

    # 自定义模式: 全局默认值
    movie-count: 1000
    series-count: 500
    episode-count: 5000
    song-count: 2000
    album-count: 200

    # 针对特定媒体库自定义 (优先级更高)
    library-counts:
      - library-id: "abc123def456"  # 媒体库 ID
        name: "电影库A"              # 名称 (可选, 仅用于注释)
        movie-count: 500
        item-count: 500

      - library-id: "def456ghi789"
        name: "电影库B"
        movie-count: 300
        item-count: 300
```

**如何获取媒体库 ID?**

1. 打开 Emby 客户端,进入某个媒体库
2. 打开浏览器开发者工具 (F12) → Network
3. 查看网络请求,找到包含 `ParentId` 参数的请求
4. `ParentId` 的值就是媒体库 ID

### Openlist 配置 (`openlist`)

```yaml
openlist:
  # Openlist 访问地址 (必填)
  host: http://192.168.1.100:5244

  # Openlist API Token (必填)
  # 在 Openlist 后台: 设置 → 令牌 → 复制
  token: openlist-xxxxxxxxxxxxx
```

#### 本地目录树生成 (可选, 高级功能)

如果你不想使用 rclone/CloudDrive2 挂载,可以用这个功能:

```yaml
openlist:
  local-tree-gen:
    # 是否启用 (默认 false)
    enable: true

    # 是否启用 ffmpeg 辅助 (默认 false)
    # 启用后可以提取真实时长和音乐标签
    # 注意: 可能有风控风险!
    ffmpeg-enable: false

    # 虚拟媒体容器 (推荐)
    # 生成与媒体同名的空文件,播放时走直链
    virtual-containers: mp4,mkv

    # STRM 媒体容器 (备选)
    # 生成 .strm 文件,兼容性更好但体验稍差
    strm-containers: ts

    # 音乐媒体容器 (可选)
    # 生成带标签的音乐虚拟文件
    # 必须启用 ffmpeg-enable 才生效
    music-containers: mp3,flac

    # 自动删除保护 (重要!)
    # 当检测到要删除的文件数量超过此值时,停止删除
    # 防止 Openlist 挂载异常导致误删
    # 建议设为总文件数的 3/4
    auto-remove-max-count: 6000

    # 刷新间隔 (分钟)
    # 每隔多久同步一次远程变化
    refresh-interval: 60

    # 扫描前缀 (可选)
    # 只扫描指定目录,不填则全量扫描
    scan-prefixes:
      - /电影
      - /电视剧

    # 忽略容器 (重要!)
    # 避免下载这些文件到本地
    ignore-containers: jpg,jpeg,png,txt,nfo,md

    # 同步线程数 (可选, 默认 8)
    threads: 8
```

**三种生成模式对比**:

| 模式 | 文件类型 | 速度 | 时长准确性 | 风控风险 | 推荐场景 |
|------|---------|------|-----------|---------|---------|
| Strm | .strm 文本 | 极快 | 准确 | 无 | 兼容性优先 |
| 虚拟文件 | 空文件 | 快 | 固定3小时 | 无 | 快速部署 |
| 虚拟文件+ffmpeg | 空文件+元数据 | 较慢 | 准确 | 有 | 体验优先 |

**首次部署建议**:

```yaml
openlist:
  local-tree-gen:
    enable: true
    ffmpeg-enable: false          # 先不开 ffmpeg
    virtual-containers: mp4,mkv   # 使用虚拟文件
    strm-containers: ts,avi       # 老旧格式用 strm
    ignore-containers: jpg,jpeg,png,txt,nfo,md
```

等熟悉后再开启 `ffmpeg-enable: true`。

### 转码配置 (`video-preview`)

**仅对阿里云盘有效!**

```yaml
video-preview:
  # 是否启用转码 (默认 true)
  enable: true

  # 对哪些容器获取转码信息
  containers:
    - mp4
    - mkv

  # 忽略哪些清晰度 (可选)
  # LD: 流畅 (360p)
  # SD: 标清 (480p)
  # HD: 高清 (720p)
  # FHD: 全高清 (1080p)
  ignore-template-ids:
    - LD  # 一般不需要流畅版
    - SD  # 一般不需要标清版
```

**清晰度对照**:

- `LD`: 360p, 适合极低带宽
- `SD`: 480p, 适合低带宽
- `HD`: 720p, 适合一般带宽
- `FHD`: 1080p, 适合较高带宽

**如果网速很快**:

```yaml
video-preview:
  enable: false  # 直接关闭转码,只用原画
```

**如果网速一般**:

```yaml
video-preview:
  enable: true
  ignore-template-ids:
    - LD
    - SD
```

保留 HD 和 FHD,给用户更多选择。

### 路径映射 (`path`)

**这是最重要也最容易配错的部分!**

```yaml
path:
  # Emby 路径到 Openlist 路径的映射 (必填)
  # 格式: Emby容器内路径:Openlist路径
  emby2openlist:
    - /data/movie:/电影
    - /data/series:/电视剧
    - /data/music:/音乐
```

#### 如何确定正确的映射?

**方法 1: 通过 Emby 查看**

1. 在 Emby 中打开一个视频的详细信息
2. 查看 "路径" 字段,比如: `/data/movie/星际穿越/星际穿越.mkv`
3. 前缀是 `/data/movie`

**方法 2: 查看 Emby 媒体库设置**

1. Emby 后台 → 媒体库 → 编辑
2. 查看 "文件夹" 配置,比如: `/data/movie`

**对应 Openlist 路径**:

在 Openlist 中找到这个文件,比如路径是 `/电影/星际穿越/星际穿越.mkv`,前缀就是 `/电影`。

**配置映射**:

```yaml
path:
  emby2openlist:
    - /data/movie:/电影
```

#### 常见错误

❌ **错误 1: 使用宿主机路径**

```yaml
path:
  emby2openlist:
    - /mnt/clouddrive/movie:/电影  # 错误!
```

应该用 Emby **容器内**的路径,不是宿主机路径。

✅ **正确**:

```yaml
path:
  emby2openlist:
    - /data/movie:/电影  # Emby 容器内路径
```

❌ **错误 2: 映射方向反了**

```yaml
path:
  emby2openlist:
    - /电影:/data/movie  # 反了!
```

格式是 `Emby路径:Openlist路径`。

✅ **正确**:

```yaml
path:
  emby2openlist:
    - /data/movie:/电影
```

❌ **错误 3: 路径不匹配**

Emby 返回路径: `/data/media/movie/xxx.mkv`
配置映射: `/data/movie:/电影`

前缀不匹配,无法转换!

✅ **正确**:

```yaml
path:
  emby2openlist:
    - /data/media/movie:/电影
```

#### 多媒体库映射

如果你有多个媒体库:

```yaml
path:
  emby2openlist:
    - /data/movie:/电影           # 电影库
    - /data/series:/电视剧        # 电视剧库
    - /data/anime:/动漫           # 动漫库
    - /data/music:/音乐           # 音乐库
    - /data/documentary:/纪录片   # 纪录片库
```

程序会按顺序匹配,第一个匹配的生效。

### 缓存配置 (`cache`)

```yaml
cache:
  # 是否启用缓存 (默认 true, 强烈推荐启用)
  enable: true

  # 缓存过期时间 (默认 1d)
  # 可用单位: d(天), h(小时), m(分钟), s(秒)
  # 这个配置不影响特殊接口 (直链/字幕等)
  expired: 1d
```

**特殊接口的缓存时间 (固定, 不受 expired 影响)**:

- 网盘直链: **10 分钟** (阿里云盘直链会过期)
- 字幕: **30 天** (字幕不会变化)
- PlaybackInfo: **12 小时** (播放信息缓存)

**如果遇到问题可以临时禁用缓存**:

```yaml
cache:
  enable: false
```

排查问题后记得重新启用。

### SSL 配置 (`ssl`)

```yaml
ssl:
  # 是否启用 HTTPS (默认 false)
  enable: true

  # 是否使用单一端口 (默认 false)
  # true: 只监听 8094 HTTPS,不监听 8095 HTTP
  # false: 同时监听 8094 HTTPS 和 8095 HTTP
  single-port: false

  # 私钥文件名 (必须放在 ssl 目录下)
  key: your-domain.key

  # 证书文件名 (必须放在 ssl 目录下)
  crt: your-domain.crt
```

**如何获取证书?**

1. **使用 Let's Encrypt 免费证书**:

```bash
# 安装 certbot
apt install certbot

# 申请证书
certbot certonly --standalone -d your-domain.com

# 证书位置:
# 私钥: /etc/letsencrypt/live/your-domain.com/privkey.pem
# 证书: /etc/letsencrypt/live/your-domain.com/fullchain.pem
```

2. **复制到项目目录**:

```bash
mkdir -p ~/go-emby2openlist/ssl
cp /etc/letsencrypt/live/your-domain.com/privkey.pem ~/go-emby2openlist/ssl/your-domain.key
cp /etc/letsencrypt/live/your-domain.com/fullchain.pem ~/go-emby2openlist/ssl/your-domain.crt
```

3. **修改配置**:

```yaml
ssl:
  enable: true
  key: your-domain.key
  crt: your-domain.crt
```

**注意**:

某些 Emby 客户端可能会在首次使用 HTTPS 后自动切换回 HTTP,这是客户端的问题,目前无解。

### OSS 对象存储配置 (`oss`)

**适用场景**: 媒体文件存储在 S3/OSS/COS 等对象存储中。

```yaml
oss:
  # 是否启用 OSS 模式 (默认 false)
  # 启用后将不再使用 Openlist
  enable: true

  # 对象存储访问域名 (必填)
  endpoint: https://s3.example.com

  # 存储桶名称 (可选)
  # 如果 URL 不包含 bucket,留空
  bucket: my-media

  # 路径映射 (必填)
  # 格式: Emby路径:OSS路径
  path-mapping:
    - /movie:/movies
    - /series:/tv-shows

  # CDN Type-A 鉴权配置 (可选)
  cdn-auth:
    enable: true
    private-key: your-cdn-private-key  # CDN 鉴权密钥
    ttl: 3600                          # 链接有效期 (秒)
    uid: 0
    use-random: true

  # API Key 验证 (可选)
  api-key:
    enable: true
    header-name: X-Api-Key
    key: your-api-key
```

**OSS 模式 vs Openlist 模式**:

- OSS 模式: 媒体在对象存储,直接生成 OSS URL
- Openlist 模式: 媒体在网盘,通过 Openlist 获取直链

两种模式**互斥**,只能选一种。

### GoEdge CDN 配置 (`goedge`)

类似 OSS 配置,用于 GoEdge CDN。

```yaml
goedge:
  enable: false
  endpoint: https://cdn.example.com
  path-mapping:
    - /movie:/media
  auth:
    enable: true
    private-key: your-key
    ttl: 3600
```

---

## 功能使用指南

### 功能 1: 直链播放 (核心功能)

**效果**: 视频直接从网盘下载,不消耗服务器流量。

**配置**: 无需额外配置,默认启用。

**使用**:

1. 在 Emby 客户端打开视频
2. 点击播放
3. 程序自动重定向到网盘直链
4. 客户端直接从网盘下载

**验证**: 播放时查看服务器流量,应该几乎不增长。

### 功能 2: 转码播放 (阿里云盘)

**效果**: 网速不够时,可以选择低清晰度版本播放。

**配置**:

```yaml
video-preview:
  enable: true
  containers:
    - mp4
    - mkv
  ignore-template-ids:
    - LD
    - SD
```

**使用**:

1. 打开视频,点击播放按钮旁的菜单
2. 选择 "播放版本" 或 "Play Version"
3. 看到 `原画`, `FHD`, `HD` 等选项
4. 选择合适的清晰度播放

**注意**:

- 转码版本需要阿里云盘支持
- 首次获取转码信息可能较慢 (2-3 秒)
- 之后会缓存 12 小时

### 功能 3: 本地目录树生成

**效果**: 不需要 rclone/CloudDrive2,程序自动生成目录结构供 Emby 扫描。

**配置**:

```yaml
openlist:
  local-tree-gen:
    enable: true
    ffmpeg-enable: false
    virtual-containers: mp4,mkv
    strm-containers: ts
    refresh-interval: 60
    ignore-containers: jpg,jpeg,png,txt,nfo,md
```

**使用**:

1. 启动程序,等待首次全量扫描 (可能需要几分钟到几小时, 取决于文件数量)
2. 查看日志,看到 "扫描完成" 信息
3. 生成的目录在 `./openlist-local-tree` 目录
4. 在 Emby 中添加媒体库,路径指向容器内的 `/app/openlist-local-tree`

**Docker 配置**:

在 `docker-compose.yml` 中添加映射:

```yaml
services:
  go-emby2openlist:
    volumes:
      - ./openlist-local-tree:/app/openlist-local-tree

  emby:
    volumes:
      - ./openlist-local-tree:/media/openlist:ro  # 只读挂载
```

**Emby 媒体库配置**:

添加媒体库 → 选择路径 → `/media/openlist/电影`

**注意事项**:

- 首次扫描可能很慢,请耐心等待
- 开启 `ffmpeg-enable` 有风控风险,谨慎使用
- 建议先用 `ffmpeg-enable: false` 测试

### 功能 4: 自定义 JS/CSS 注入

**效果**: 在 Emby Web 客户端注入自定义脚本和样式。

**配置**: 无需配置,只需放置文件。

**使用**:

1. **创建目录**:

```bash
mkdir -p ~/go-emby2openlist/custom-js
mkdir -p ~/go-emby2openlist/custom-css
```

2. **添加 JS 脚本**:

将 `.js` 文件放到 `custom-js` 目录:

```bash
# 下载外部播放器按钮脚本
wget https://emby-external-url.7o7o.cc/embyWebAddExternalUrl/embyLaunchPotplayer.js \
  -O ~/go-emby2openlist/custom-js/external-player.js
```

3. **添加 CSS 样式**:

将 `.css` 文件放到 `custom-css` 目录:

```css
/* ~/go-emby2openlist/custom-css/custom-style.css */
.itemDetailPage {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
```

4. **远程脚本/样式**:

如果脚本托管在远程,可以创建一个文件,内容为 URL:

```bash
# custom-js/remote-script.js 文件内容:
https://example.com/path/to/script.js
```

5. **重启服务**:

```bash
docker-compose restart
```

6. **验证**:

打开 Emby Web,按 F12 打开开发者工具,查看是否加载了自定义脚本。

**常用脚本推荐**:

| 功能 | 地址 |
|------|------|
| 外部播放器按钮 | https://emby-external-url.7o7o.cc/embyWebAddExternalUrl/embyLaunchPotplayer.js |
| 首页轮播图 | https://raw.githubusercontent.com/newday-life/emby-web-mod/main/emby-swiper/emby-swiper.js |
| 隐藏无图片演员 | https://raw.githubusercontent.com/newday-life/emby-web-mod/main/actorPlus/actorPlus.js |

### 功能 5: 字幕缓存

**效果**: 字幕提取后缓存 30 天,下次播放秒开。

**配置**: 无需配置,自动生效。

**注意**:

- 首次提取内嵌字幕会很慢 (需要下载整个视频文件)
- 提取时会消耗服务器流量
- 建议使用**外挂字幕** (单独的 .srt 文件)

**外挂字幕命名规范**:

```
电影名.mkv
电影名.zh.srt      # 中文字幕
电影名.zh.forced.srt  # 强制字幕
电影名.en.srt      # 英文字幕
```

### 功能 6: OSS 直链模式

**适用场景**: 媒体文件在对象存储 (S3/OSS/COS),不在网盘。

**配置**:

```yaml
oss:
  enable: true
  endpoint: https://s3.example.com
  bucket: media
  path-mapping:
    - /movie:/movies
    - /series:/tv-shows
  cdn-auth:
    enable: true
    private-key: your-secret
    ttl: 3600
```

**使用**:

配置后无需额外操作,程序会自动生成带鉴权的 OSS 直链。

**与 Openlist 模式的区别**:

- OSS 模式不支持转码
- OSS 模式不需要 Openlist
- 直接重定向到对象存储 URL

---

## 常见问题

### Q1: 配置后无法播放视频?

**排查步骤**:

1. **检查日志**:

```bash
docker logs -f go-emby2openlist -n 200
```

查看是否有报错信息。

2. **验证 Emby 连接**:

```bash
curl http://你的Emby地址:8096/emby/System/Info
```

应该返回 JSON 数据。

3. **验证 Openlist 连接**:

```bash
curl -H "Authorization: 你的Token" http://你的Openlist地址:5244/api/fs/list
```

应该返回文件列表。

4. **检查路径映射**:

在日志中搜索 "路径转换",查看转换结果是否正确。

5. **测试直链**:

手动访问 Openlist API:

```bash
curl -X POST http://你的Openlist地址:5244/api/fs/get \
  -H "Authorization: 你的Token" \
  -H "Content-Type: application/json" \
  -d '{"path": "/电影/测试.mkv"}'
```

应该返回包含 `raw_url` 的 JSON。

### Q2: 转码版本不显示?

**可能原因**:

1. **配置未启用**:

```yaml
video-preview:
  enable: true  # 确认是 true
```

2. **容器不匹配**:

检查视频容器是否在配置中:

```yaml
video-preview:
  containers:
    - mp4
    - mkv  # 确认包含你的视频格式
```

3. **阿里云盘不支持转码**:

不是所有视频都支持转码,尝试其他视频。

4. **清晰度被忽略**:

检查 `ignore-template-ids` 配置:

```yaml
video-preview:
  ignore-template-ids:
    # - FHD  # 如果包含 FHD,就不会显示 FHD 版本
```

### Q3: 字幕加载很慢?

**原因**: 首次提取内嵌字幕需要下载整个视频。

**解决方案**:

1. **使用外挂字幕** (推荐):

将字幕文件放在视频旁边:

```
电影名.mkv
电影名.zh.srt  # 中文字幕
```

2. **等待首次提取完成**: 提取后会缓存 30 天。

3. **使用支持外部字幕的播放器**: 如 MX Player, Fileball。

### Q4: 路径映射配置不生效?

**常见错误**:

1. **使用了宿主机路径**:

❌ `/mnt/clouddrive/movie:/电影`
✅ `/data/movie:/电影` (Emby 容器内路径)

2. **映射方向反了**:

❌ `/电影:/data/movie`
✅ `/data/movie:/电影`

3. **前缀不匹配**:

Emby 路径: `/data/media/movie/xxx`
映射配置: `/data/movie:/电影`

前缀 `/data/media/movie` ≠ `/data/movie`,无法匹配。

✅ 正确: `/data/media/movie:/电影`

**调试方法**:

启用调试模式:

```bash
docker-compose down
GIN_MODE=debug docker-compose up
```

查看日志中的路径转换信息。

### Q5: 本地目录树生成很慢?

**正常现象**: 首次全量扫描需要时间,文件越多越慢。

**优化方法**:

1. **使用 scan-prefixes 限制扫描范围**:

```yaml
openlist:
  local-tree-gen:
    scan-prefixes:
      - /电影  # 只扫描电影目录
```

2. **增加线程数**:

```yaml
openlist:
  local-tree-gen:
    threads: 16  # 默认 8
```

3. **禁用 ffmpeg**:

```yaml
openlist:
  local-tree-gen:
    ffmpeg-enable: false  # 快很多
```

**进度查看**:

```bash
docker logs -f go-emby2openlist | grep "扫描进度"
```

### Q6: 客户端显示 "播放失败"?

**排查步骤**:

1. **检查客户端兼容性**: 参考 README 中的兼容性列表。

2. **检查直链是否有效**:

在浏览器中直接访问直链 URL,看能否下载。

3. **检查网络连通性**:

客户端需要能访问网盘服务器。

4. **查看客户端日志**: 某些客户端有日志功能,查看具体错误。

5. **尝试原画版本**: 如果转码失败,尝试播放原画。

### Q7: Docker 容器无法启动?

**可能原因**:

1. **配置文件格式错误**:

```bash
# 验证 YAML 语法
docker run --rm -v $(pwd):/data cytopia/yamllint config.yml
```

2. **端口被占用**:

```bash
# 检查端口
netstat -tulpn | grep 8095
```

修改 `docker-compose.yml` 中的端口映射。

3. **权限问题**:

```bash
# 赋予执行权限
chmod -R 755 ~/go-emby2openlist
```

4. **查看详细日志**:

```bash
docker-compose up  # 不用 -d,查看启动日志
```

---

## 进阶用法

### 多实例部署

如果你有多个 Emby 服务器:

```bash
# 实例 1
mkdir ~/emby-instance-1
cd ~/emby-instance-1
# 配置 config.yml, 修改端口为 8095

# 实例 2
mkdir ~/emby-instance-2
cd ~/emby-instance-2
# 配置 config.yml, 修改端口为 9095
```

### 反向代理 (Nginx)

使用 Nginx 反向代理 go-emby2openlist:

```nginx
server {
    listen 80;
    server_name emby.example.com;

    location / {
        proxy_pass http://localhost:8095;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 大文件支持
        proxy_buffering off;
        client_max_body_size 0;
    }
}
```

### 监控和日志

#### 日志查看

```bash
# 实时日志
docker logs -f go-emby2openlist

# 最近 200 行
docker logs --tail 200 go-emby2openlist

# 搜索错误
docker logs go-emby2openlist 2>&1 | grep -i error
```

#### 性能监控

程序默认在 60360 端口开启 pprof:

```bash
# CPU 性能分析
go tool pprof http://localhost:60360/debug/pprof/profile

# 内存分析
go tool pprof http://localhost:60360/debug/pprof/heap

# Goroutine 分析
curl http://localhost:60360/debug/pprof/goroutine?debug=1
```

### 自动更新脚本

创建 `update.sh`:

```bash
#!/bin/bash

cd ~/go-emby2openlist

echo "拉取最新代码..."
git fetch --tags
git checkout v2.3.2  # 或最新版本号
git pull

echo "检查配置更新..."
diff config.yml config-example.yml || echo "配置文件可能需要更新!"

echo "重新构建镜像..."
docker-compose down
docker-compose build --no-cache
docker-compose up -d

echo "清理旧镜像..."
docker image prune -f

echo "更新完成! 查看日志:"
docker logs -f go-emby2openlist -n 100
```

使用:

```bash
chmod +x update.sh
./update.sh
```

### 配置热更新

修改配置后无需重新构建镜像:

```bash
# 修改 config.yml
vim ~/go-emby2openlist/config.yml

# 重启容器
docker-compose restart

# 查看日志验证
docker logs -f go-emby2openlist
```

---

## 故障排查

### 问题排查流程

```
1. 查看日志
   ↓
2. 确认服务状态 (Emby/Openlist 是否正常)
   ↓
3. 验证网络连通性
   ↓
4. 检查配置文件
   ↓
5. 测试单个组件
   ↓
6. 提交 Issue
```

### 常见错误及解决

#### 错误 1: "无法连接到 Emby 服务器"

```
[ERROR] 无法连接到 Emby 服务器: dial tcp: connection refused
```

**原因**: Emby 地址配置错误或 Emby 未启动。

**解决**:

```bash
# 测试 Emby 连接
curl http://你的Emby地址:8096/emby/System/Info

# 检查配置
grep "host:" config.yml
```

#### 错误 2: "Openlist Token 无效"

```
[ERROR] Openlist API 返回 401: Unauthorized
```

**原因**: Token 配置错误。

**解决**:

1. 登录 Openlist 后台
2. 设置 → 令牌 → 复制 Token
3. 更新 `config.yml`:

```yaml
openlist:
  token: openlist-新的Token
```

#### 错误 3: "路径转换失败"

```
[WARN] 无法转换 Emby 路径: /data/movie/xxx.mkv
```

**原因**: 路径映射配置不匹配。

**解决**:

1. 查看 Emby 中的完整路径
2. 确认配置中的前缀匹配:

```yaml
path:
  emby2openlist:
    - /data/movie:/电影  # 确保前缀正确
```

#### 错误 4: "缓存空间不足"

```
[WARN] 缓存空间已满, 清理旧缓存...
```

**原因**: 正常现象,程序会自动清理。

**如果频繁出现**: 考虑增加缓存限制 (需要修改源码)。

#### 错误 5: "ffmpeg 初始化失败"

```
[ERROR] ffmpeg 初始化失败: 下载超时
```

**原因**: 网络问题,无法下载 ffmpeg。

**解决**:

1. **临时禁用 ffmpeg**:

```yaml
openlist:
  local-tree-gen:
    ffmpeg-enable: false
```

2. **手动安装 ffmpeg**:

```bash
# 进入容器
docker exec -it go-emby2openlist sh

# 安装 ffmpeg
apk add ffmpeg
```

### 调试模式

启用详细日志:

```bash
# 停止容器
docker-compose down

# 设置调试模式
export GIN_MODE=debug

# 启动 (不用 -d, 查看输出)
docker-compose up
```

或修改 `docker-compose.yml`:

```yaml
services:
  go-emby2openlist:
    environment:
      - GIN_MODE=debug
```

### 提交 Issue

如果以上方法都无法解决,请提交 Issue:

**Issue 模板**:

```markdown
## 问题描述
简要描述问题

## 环境信息
- go-emby2openlist 版本: v2.3.2
- Emby 版本: 4.8.8.0
- 客户端: Emby for Android 3.4.23
- 网盘: 阿里云盘

## 配置文件
(粘贴脱敏后的 config.yml)

## 日志输出
(粘贴相关日志)

## 复现步骤
1. ...
2. ...

## 预期行为
应该...

## 实际行为
实际...
```

提交 Issue: https://github.com/AmbitiousJun/go-emby2openlist/issues

---

## 总结

### 核心要点

1. **路径映射是关键**: 确保 Emby 路径能正确映射到 Openlist 路径
2. **容器内路径 vs 宿主机路径**: 配置时使用 Emby 容器内的路径
3. **缓存很重要**: 启用缓存可大幅提升性能
4. **日志是最好的帮手**: 遇到问题先查看日志

### 推荐配置 (适合大多数用户)

```yaml
emby:
  host: http://192.168.1.100:8096
  mount-path: /data
  proxy-error-strategy: origin

openlist:
  host: http://192.168.1.100:5244
  token: openlist-xxxxx

video-preview:
  enable: true
  containers: [mp4, mkv]
  ignore-template-ids: [LD, SD]

path:
  emby2openlist:
    - /data/movie:/电影
    - /data/series:/电视剧

cache:
  enable: true
  expired: 1d
```

### 下一步

- 阅读 [原理说明文档](./原理说明.md) 深入理解工作原理
- 加入社区交流: https://t.me/emby_group
- 查看项目仓库: https://github.com/AmbitiousJun/go-emby2openlist

祝使用愉快!
