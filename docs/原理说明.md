# go-emby2openlist åŸç†è¯´æ˜

æœ¬æ–‡æ¡£æ—¨åœ¨ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Š go-emby2openlist é¡¹ç›®çš„å·¥ä½œåŸç†,å¸®åŠ©ç”¨æˆ·æ·±å…¥ç†è§£è¿™ä¸ªç½‘ç›˜ç›´é“¾åå‘ä»£ç†æœåŠ¡ã€‚

## ç›®å½•

- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
- [å·¥ä½œåŸç†](#å·¥ä½œåŸç†)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [å…³é”®æµç¨‹](#å…³é”®æµç¨‹)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯åå‘ä»£ç†?

åå‘ä»£ç†å°±åƒä¸€ä¸ª"ä¸­é—´äºº",å®ƒæ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚,ç„¶åè½¬å‘ç»™çœŸæ­£çš„æœåŠ¡å™¨,å†æŠŠæœåŠ¡å™¨çš„å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯ä»¥ä¸ºè‡ªå·±åœ¨ç›´æ¥è®¿é—®æœåŠ¡å™¨,ä½†å®é™…ä¸Šä¸­é—´ç»è¿‡äº†ä»£ç†çš„å¤„ç†ã€‚

### ä»€ä¹ˆæ˜¯ç½‘ç›˜ç›´é“¾?

ç½‘ç›˜ç›´é“¾æ˜¯æŒ‡å¯ä»¥ç›´æ¥ä»ç½‘ç›˜æœåŠ¡å™¨ä¸‹è½½æ–‡ä»¶çš„ URL åœ°å€,ä¸éœ€è¦ç»è¿‡ä»»ä½•ä¸­é—´æœåŠ¡å™¨ã€‚é˜¿é‡Œäº‘ç›˜ã€ç™¾åº¦ç½‘ç›˜ç­‰éƒ½æä¾›äº†è·å–ç›´é“¾çš„ APIã€‚

### ä¸ºä»€ä¹ˆéœ€è¦åå‘ä»£ç†?

æ­£å¸¸æƒ…å†µä¸‹,Emby æ’­æ”¾ç½‘ç›˜è§†é¢‘çš„æ•°æ®æµå‘æ˜¯:

```
å®¢æˆ·ç«¯ -> EmbyæœåŠ¡å™¨ -> ç£ç›˜æŒ‚è½½æœåŠ¡ -> ç½‘ç›˜
```

è¿™ç§æ–¹å¼æœ‰å‡ ä¸ªé—®é¢˜:
1. **æ¶ˆè€—æœåŠ¡å™¨å¸¦å®½**: è§†é¢‘æµé‡å…¨éƒ¨ç»è¿‡ä½ çš„æœåŠ¡å™¨
2. **é€Ÿåº¦å—é™**: æ’­æ”¾é€Ÿåº¦å—é™äºæœåŠ¡å™¨çš„ä¸Šä¼ å¸¦å®½
3. **æœåŠ¡å™¨å‹åŠ›å¤§**: å¤šäººåŒæ—¶è§‚çœ‹ä¼šå¯¼è‡´æœåŠ¡å™¨å¡é¡¿

ä½¿ç”¨åå‘ä»£ç†å:

```
å®¢æˆ·ç«¯ -> go-emby2openlist -> EmbyæœåŠ¡å™¨ (ä»…è·å–å…ƒæ•°æ®)
å®¢æˆ·ç«¯ -> ç½‘ç›˜ (ç›´æ¥ä¸‹è½½è§†é¢‘)
```

è¿™æ ·ä¸€æ¥:
1. **ä¸æ¶ˆè€—æœåŠ¡å™¨å¸¦å®½**: è§†é¢‘æµé‡ç›´æ¥ä»ç½‘ç›˜åˆ°å®¢æˆ·ç«¯
2. **é€Ÿåº¦æ›´å¿«**: å—é™äºä½ çš„ç½‘ç›˜ä¼šå‘˜é€Ÿåº¦
3. **æœåŠ¡å™¨å‹åŠ›å°**: æœåŠ¡å™¨åªéœ€è¦å¤„ç†å°‘é‡çš„ API è¯·æ±‚

---

## å·¥ä½œåŸç†

### æ•´ä½“æµç¨‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­æ¥ç†è§£ go-emby2openlist çš„å·¥ä½œæµç¨‹:

#### 1. å®¢æˆ·ç«¯è¯·æ±‚æ’­æ”¾è§†é¢‘

å½“ä½ åœ¨ Emby å®¢æˆ·ç«¯ç‚¹å‡»æ’­æ”¾ä¸€ä¸ªè§†é¢‘æ—¶,å®¢æˆ·ç«¯ä¼šå‘ go-emby2openlist å‘é€è¯·æ±‚:

```
GET http://ä½ çš„åä»£åœ°å€:8095/emby/Videos/12345/stream?api_key=xxx
```

#### 2. è·¯ç”±åŒ¹é…

go-emby2openlist ä½¿ç”¨**æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…**æ¥è¯†åˆ«è¿™æ˜¯ä»€ä¹ˆç±»å‹çš„è¯·æ±‚ã€‚

åœ¨ `internal/web/route.go` ä¸­å®šä¹‰äº† 26 æ¡è·¯ç”±è§„åˆ™,æŒ‰é¡ºåºåŒ¹é…:

```go
{constant.Reg_PlaybackInfo, emby.TransferPlaybackInfo},  // æ’­æ”¾ä¿¡æ¯æ¥å£
{constant.Reg_VideoSubtitles, emby.ProxySubtitles},      // å­—å¹•æ¥å£
{constant.Reg_StreamRedirect, emby.Redirect2OpenlistLink}, // è§†é¢‘æµé‡å®šå‘
...
```

**é‡è¦**: è§„åˆ™æ˜¯æŒ‰é¡ºåºæ£€æŸ¥çš„,ç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™ä¼šè¢«æ‰§è¡Œã€‚

#### 3. API Key éªŒè¯

ç¨‹åºä¼šæ£€æŸ¥è¯·æ±‚ä¸­çš„ `api_key` å‚æ•°æ˜¯å¦æœ‰æ•ˆ:

- é¦–æ¬¡é‡åˆ°æŸä¸ª API Key æ—¶,ä¼šå‘ Emby æºæœåŠ¡å™¨éªŒè¯
- éªŒè¯é€šè¿‡å,ä¼šç¼“å­˜è¿™ä¸ª Key (ä½¿ç”¨ `sync.Map` å­˜å‚¨)
- ä¸‹æ¬¡å†é‡åˆ°ç›¸åŒçš„ Key,ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–,æ— éœ€å†æ¬¡éªŒè¯

#### 4. è·å–åª’ä½“ä¿¡æ¯

ç¨‹åºéœ€è¦çŸ¥é“è¿™ä¸ªè§†é¢‘åœ¨ Emby æœåŠ¡å™¨ä¸Šçš„**æœ¬åœ°æ–‡ä»¶è·¯å¾„**:

```
GET http://embyæºåœ°å€:8096/emby/Items/12345?api_key=xxx
```

Emby è¿”å›çš„ä¿¡æ¯åŒ…å«:

```json
{
  "Id": "12345",
  "Name": "æ˜Ÿé™…ç©¿è¶Š (2014)",
  "Path": "/movie/æ˜Ÿé™…ç©¿è¶Š (2014)/æ˜Ÿé™…ç©¿è¶Š (2014) - 2160p.mkv",
  ...
}
```

#### 5. è·¯å¾„è½¬æ¢

ç°åœ¨æˆ‘ä»¬æœ‰äº† Emby çš„æœ¬åœ°è·¯å¾„,éœ€è¦å°†å…¶è½¬æ¢ä¸º Openlist è·¯å¾„ã€‚

**è·¯å¾„è½¬æ¢é€»è¾‘** (`internal/service/path/path.go`):

1. URL è§£ç  (å¤„ç† `%20` ç­‰ç¼–ç å­—ç¬¦)
2. åæ–œæ è½¬æ­£æ–œæ  (Windows -> Unix)
3. ç§»é™¤ Emby æŒ‚è½½è·¯å¾„å‰ç¼€
4. åº”ç”¨é…ç½®ä¸­çš„è·¯å¾„æ˜ å°„

**ç¤ºä¾‹**:

é…ç½®æ–‡ä»¶ä¸­çš„æ˜ å°„:
```yaml
path:
  emby2openlist:
    - /movie:/ç”µå½±
    - /series:/ç”µè§†å‰§
```

è½¬æ¢è¿‡ç¨‹:
```
Embyè·¯å¾„: /movie/æ˜Ÿé™…ç©¿è¶Š (2014)/æ˜Ÿé™…ç©¿è¶Š (2014) - 2160p.mkv
â†“ ç§»é™¤å‰ç¼€ /movie
æ˜Ÿé™…ç©¿è¶Š (2014)/æ˜Ÿé™…ç©¿è¶Š (2014) - 2160p.mkv
â†“ æ·»åŠ  Openlist å‰ç¼€ /ç”µå½±
Openlistè·¯å¾„: /ç”µå½±/æ˜Ÿé™…ç©¿è¶Š (2014)/æ˜Ÿé™…ç©¿è¶Š (2014) - 2160p.mkv
```

#### 6. è·å–ç½‘ç›˜ç›´é“¾

æœ‰äº† Openlist è·¯å¾„å,å‘ Openlist API è¯·æ±‚ç›´é“¾:

**åŸç”»ç›´é“¾**:
```
POST http://openliståœ°å€:5244/api/fs/get
{
  "path": "/ç”µå½±/æ˜Ÿé™…ç©¿è¶Š (2014)/æ˜Ÿé™…ç©¿è¶Š (2014) - 2160p.mkv"
}
```

**è½¬ç ç›´é“¾** (é˜¿é‡Œäº‘ç›˜):
```
POST http://openliståœ°å€:5244/api/fs/other
{
  "path": "/ç”µå½±/æ˜Ÿé™…ç©¿è¶Š (2014)/æ˜Ÿé™…ç©¿è¶Š (2014) - 2160p.mkv",
  "method": "video_preview",
  "data": {
    "template_id": "FHD"  // æ¸…æ™°åº¦
  }
}
```

Openlist è¿”å›ç›´é“¾:
```json
{
  "data": {
    "raw_url": "https://cn-beijing-data.aliyundrive.net/xxx?auth_key=yyy"
  }
}
```

#### 7. é‡å®šå‘åˆ°ç›´é“¾

ç¨‹åºè¿”å› **302 é‡å®šå‘** å“åº”ç»™å®¢æˆ·ç«¯:

```http
HTTP/1.1 302 Temporary Redirect
Location: https://cn-beijing-data.aliyundrive.net/xxx?auth_key=yyy
```

#### 8. å®¢æˆ·ç«¯ç›´è¿ç½‘ç›˜

å®¢æˆ·ç«¯æ”¶åˆ°é‡å®šå‘å,ä¼šç›´æ¥ä»ç½‘ç›˜ä¸‹è½½è§†é¢‘,ä¸å†ç»è¿‡ä½ çš„æœåŠ¡å™¨ã€‚

---

## æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿåˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Gin HTTP æœåŠ¡å™¨                â”‚
â”‚         (ç«¯å£: 8095/8094)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸­é—´ä»¶é“¾                    â”‚
â”‚  ApiKeyChecker â†’ CacheMarker â†’ Cacher   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            è·¯ç”±åŒ¹é…å™¨                    â”‚
â”‚       (æ­£åˆ™è¡¨è¾¾å¼è§„åˆ™é“¾)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä¸šåŠ¡å¤„ç†å±‚                     â”‚
â”‚  Emby â”‚ Openlist â”‚ M3U8 â”‚ Path â”‚ OSS   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å¤–éƒ¨æœåŠ¡                        â”‚
â”‚   Emby Server â”‚ Openlist â”‚ ç½‘ç›˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæœåŠ¡æ¨¡å—

#### 1. Emby Service (`internal/service/emby/`)

è´Ÿè´£æ‹¦æˆªå’Œä¿®æ”¹ Emby API è°ƒç”¨ã€‚

**å…³é”®æ–‡ä»¶**:

- `playbackinfo.go`: æ‹¦æˆª `PlaybackInfo` æ¥å£,æ·»åŠ è½¬ç ç‰ˆæœ¬ä¿¡æ¯
- `redirect.go`: æ ¸å¿ƒé‡å®šå‘é€»è¾‘,å°† Emby è·¯å¾„æ˜ å°„åˆ°ç½‘ç›˜ç›´é“¾
- `media.go`: æå–åª’ä½“å…ƒæ•°æ®,å¤„ç† MediaSourceId ç¼–ç 
- `auth.go`: éªŒè¯ API Key,ç¼“å­˜æœ‰æ•ˆçš„ Key

**PlaybackInfo æ¥å£çš„é­”æ³•**:

è¿™æ˜¯æœ€é‡è¦çš„æ¥å£,Emby å®¢æˆ·ç«¯åœ¨æ’­æ”¾å‰ä¼šè°ƒç”¨å®ƒæ¥è·å–å¯æ’­æ”¾çš„åª’ä½“æºã€‚

ç¨‹åºä¼š:
1. ä»£ç†è¯·æ±‚åˆ° Emby æºæœåŠ¡å™¨,è·å–åŸå§‹ `PlaybackInfo`
2. å¦‚æœé…ç½®äº†è½¬ç ,å‘ Openlist è¯·æ±‚è½¬ç ä¿¡æ¯
3. ä¸ºæ¯ä¸ªè½¬ç ç‰ˆæœ¬åˆ›å»ºä¸€ä¸ªæ–°çš„ `MediaSource`
4. ä¿®æ”¹ `DirectPlayProfiles`,è®©å®¢æˆ·ç«¯ä¼˜å…ˆç›´æ¥æ’­æ”¾
5. è¿”å›ä¿®æ”¹åçš„ `PlaybackInfo` ç»™å®¢æˆ·ç«¯

å®¢æˆ·ç«¯çœ‹åˆ°çš„æ•ˆæœ:å¯ä»¥åœ¨æ’­æ”¾æ—¶é€‰æ‹©ä¸åŒçš„æ¸…æ™°åº¦ (åŸç”»/FHD/HD/SD)ã€‚

#### 2. Openlist Service (`internal/service/openlist/`)

è´Ÿè´£ä¸ Openlist API äº¤äº’,è·å–ç½‘ç›˜ç›´é“¾ã€‚

**å…³é”®å‡½æ•°**:

- `FetchResource()`: ä¸»å…¥å£,å¤„ç†è½¬ç å›é€€åˆ°åŸç”»çš„é€»è¾‘
- `FetchFsGet()`: è·å–åŸç”»ç›´é“¾
- `FetchFsOther()`: è·å–è½¬ç ç›´é“¾

**æ™ºèƒ½å›é€€æœºåˆ¶**:

å¦‚æœè¯·æ±‚è½¬ç å¤±è´¥ (æ¯”å¦‚æ–‡ä»¶ä¸æ”¯æŒè½¬ç ),ç¨‹åºä¼šè‡ªåŠ¨å›é€€åˆ°åŸç”»:

```go
// ä¼ªä»£ç 
func FetchResource(path, templateId string) {
    if templateId == "" {
        return FetchFsGet(path)  // åŸç”»
    }

    result := FetchFsOther(path, templateId)  // è½¬ç 
    if result.Failed() {
        return FetchFsGet(path)  // å›é€€åˆ°åŸç”»
    }
    return result
}
```

#### 3. M3U8 Service (`internal/service/m3u8/`)

ç»´æŠ¤ HLS è½¬ç æ’­æ”¾åˆ—è¡¨ (ç”¨äºé˜¿é‡Œäº‘ç›˜è½¬ç )ã€‚

**å·¥ä½œåŸç†**:

é˜¿é‡Œäº‘ç›˜çš„è½¬ç è§†é¢‘æ˜¯ HLS æ ¼å¼ (m3u8 + ts åˆ†ç‰‡),ç¨‹åºéœ€è¦:

1. ä» Openlist è·å– m3u8 æ’­æ”¾åˆ—è¡¨
2. å°†æ’­æ”¾åˆ—è¡¨ä¿å­˜åœ¨å†…å­˜ä¸­
3. å½“å®¢æˆ·ç«¯è¯·æ±‚ ts åˆ†ç‰‡æ—¶,æä¾›ç›´é“¾

**å†…å­˜ç®¡ç†**:

- å•ä¸ª goroutine ç»´æŠ¤æœ€å¤š 10 ä¸ªæ’­æ”¾åˆ—è¡¨
- LRU æ·˜æ±°ç­–ç•¥ (æœ€ä¹…æœªä½¿ç”¨çš„å…ˆæ·˜æ±°)
- é¢„ç¼“å­˜é€šé“ (å¤§å° 1000) ç”¨äºå¼‚æ­¥ç”Ÿæˆæ’­æ”¾åˆ—è¡¨

**ä¸ºä»€ä¹ˆç”¨å•ä¸ª goroutine?**

é¿å…å¹¶å‘è®¿é—® map å¯¼è‡´çš„ç«æ€æ¡ä»¶,ä¸éœ€è¦åŠ é”,æ€§èƒ½æ›´å¥½ã€‚

#### 4. Path Service (`internal/service/path/`)

è´Ÿè´£è·¯å¾„è½¬æ¢: Emby è·¯å¾„ â†’ Openlist è·¯å¾„ã€‚

**è½¬æ¢æ­¥éª¤**:

1. URL è§£ç 
2. æ ‡å‡†åŒ–è·¯å¾„åˆ†éš”ç¬¦
3. ç§»é™¤ Emby æŒ‚è½½å‰ç¼€
4. åº”ç”¨è‡ªå®šä¹‰æ˜ å°„
5. å¦‚æœä¸ç¡®å®š,å°è¯•æ‰€æœ‰å¯èƒ½çš„ Openlist æ ¹ç›®å½•

**å…³é”®å‡½æ•°**:

```go
func Emby2Openlist(embyPath string) PathConvertResult {
    // è¿”å›è½¬æ¢ç»“æœ,åŒ…å«æˆåŠŸæ ‡å¿—å’Œå¯èƒ½çš„è·¯å¾„åˆ—è¡¨
}
```

#### 5. Cache Service (`internal/web/cache/`)

å“åº”ç¼“å­˜ç³»ç»Ÿ,å‡å°‘é‡å¤è¯·æ±‚ã€‚

**ç¼“å­˜é”®ç”Ÿæˆ**:

```
MD5(HTTPæ–¹æ³• + URIè·¯å¾„ + æ’åºåçš„å‚æ•° + è¯·æ±‚ä½“ + é€‰å®šçš„è¯·æ±‚å¤´)
```

**å¿½ç•¥çš„å‚æ•°** (70+ ä¸ª):

- `PlaySessionId`: æ¯æ¬¡æ’­æ”¾éƒ½ä¸åŒ,ä½†å®é™…å†…å®¹ç›¸åŒ
- `X-Forwarded-For`: å®¢æˆ·ç«¯ IP,ä¸å½±å“å“åº”å†…å®¹
- å„ç§è¿æ¥ç›¸å…³çš„å¤´: `Connection`, `Keep-Alive` ç­‰

**å†…å­˜é™åˆ¶**:

- æœ€å¤§ 100MB æ€»ç¼“å­˜å¤§å°
- æœ€å¤§ 8092 ä¸ªç¼“å­˜æ¡ç›®
- æ¯ 10 ç§’æ¸…ç†ä¸€æ¬¡è¿‡æœŸç¼“å­˜

**ç¼“å­˜æ—¶é•¿**:

- `PlaybackInfo` æ¥å£: 12 å°æ—¶
- è§†é¢‘å­—å¹•: 30 å¤©
- ç½‘ç›˜ç›´é“¾: 10 åˆ†é’Ÿ (é˜¿é‡Œäº‘ç›˜ç›´é“¾ä¼šè¿‡æœŸ)
- éšæœºåˆ—è¡¨: å¯é…ç½®

**å¦‚ä½•æ§åˆ¶ç¼“å­˜?**

å¤„ç†å‡½æ•°é€šè¿‡è®¾ç½®å“åº”å¤´æ¥æ§åˆ¶:

```go
// ç¼“å­˜ 12 å°æ—¶
c.Header(cache.HeaderKeyExpired, cache.Duration(12 * time.Hour))

// ä¸ç¼“å­˜
c.Header(cache.HeaderKeyExpired, "-1")
```

#### 6. Local Tree Service (`internal/service/openlist/localtree/`)

å°† Openlist ç›®å½•ç»“æ„åŒæ­¥åˆ°æœ¬åœ°ç£ç›˜,ä¾› Emby æ‰«æã€‚

**ä¸‰ç§æ–‡ä»¶ç”Ÿæˆæ¨¡å¼**:

1. **STRM æ–‡ä»¶**: è½»é‡æ–‡æœ¬æ–‡ä»¶,åŒ…å«è§†é¢‘ URL
   - ä¼˜ç‚¹: æå¿«,æ— éœ€ ffmpeg
   - ç¼ºç‚¹: æ’­æ”¾ä½“éªŒè¾ƒå·®

2. **è™šæ‹Ÿæ–‡ä»¶**: ç©ºæ–‡ä»¶ + å›ºå®šæ—¶é•¿å…ƒæ•°æ®
   - ä¼˜ç‚¹: è¾ƒå¿«,æ’­æ”¾è¿›åº¦æ­£å¸¸
   - ç¼ºç‚¹: æ—¶é•¿ä¸å‡†ç¡® (å›ºå®š 3 å°æ—¶)

3. **è™šæ‹Ÿæ–‡ä»¶ + ffmpeg**: ç©ºæ–‡ä»¶ + çœŸå®å…ƒæ•°æ®
   - ä¼˜ç‚¹: æ—¶é•¿å‡†ç¡®,ä½“éªŒæœ€ä½³
   - ç¼ºç‚¹: è¾ƒæ…¢,æœ‰é£æ§é£é™©

**åŒæ­¥æœºåˆ¶**:

- å•ä¸ª goroutine å®šæœŸæ‰«æ Openlist
- å¢é‡åŒæ­¥ (ä»…æ›´æ–°å˜åŒ–çš„éƒ¨åˆ†)
- å¿«ç…§å¯¹æ¯” (è®°å½•ä¸Šæ¬¡æ‰«æçŠ¶æ€)
- è‡ªåŠ¨åˆ é™¤ä¿æŠ¤ (é˜²æ­¢è¯¯åˆ å¤§é‡æ–‡ä»¶)

**é…ç½®ç¤ºä¾‹**:

```yaml
openlist:
  local-tree-gen:
    enable: true
    ffmpeg-enable: false
    virtual-containers: mp4,mkv     # ç”Ÿæˆè™šæ‹Ÿæ–‡ä»¶
    strm-containers: ts             # ç”Ÿæˆ STRM æ–‡ä»¶
    music-containers: mp3,flac      # ç”ŸæˆéŸ³ä¹è™šæ‹Ÿæ–‡ä»¶
    refresh-interval: 60            # æ¯ 60 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
```

---

## å…³é”®æµç¨‹

### æ’­æ”¾æµç¨‹è¯¦è§£

#### åœºæ™¯: ç”¨æˆ·æ’­æ”¾ä¸€ä¸ªé˜¿é‡Œäº‘ç›˜çš„ 4K ç”µå½±

**ç¬¬ 1 æ­¥: å®¢æˆ·ç«¯è¯·æ±‚ PlaybackInfo**

```
GET /emby/Items/12345/PlaybackInfo?api_key=xxx
```

**ç¬¬ 2 æ­¥: ç¨‹åºæ‹¦æˆªè¯·æ±‚**

è·¯ç”±åŒ¹é…åˆ° `constant.Reg_PlaybackInfo` è§„åˆ™,è°ƒç”¨ `emby.TransferPlaybackInfo` å¤„ç†ã€‚

**ç¬¬ 3 æ­¥: éªŒè¯ API Key**

ä»ç¼“å­˜ä¸­æŸ¥æ‰¾,å¦‚æœæ²¡æœ‰åˆ™å‘ Emby æºæœåŠ¡å™¨éªŒè¯ã€‚

**ç¬¬ 4 æ­¥: ä»£ç†åˆ°æºæœåŠ¡å™¨**

è·å–åŸå§‹çš„ `PlaybackInfo`:

```json
{
  "MediaSources": [
    {
      "Id": "12345",
      "Path": "/movie/æ˜Ÿé™…ç©¿è¶Š.mkv",
      "Container": "mkv",
      "Size": 85899345920,  // 80GB
      ...
    }
  ]
}
```

**ç¬¬ 5 æ­¥: æ£€æŸ¥æ˜¯å¦éœ€è¦è½¬ç ä¿¡æ¯**

æ£€æŸ¥é…ç½®:
- `video-preview.enable` æ˜¯å¦ä¸º `true`
- æ–‡ä»¶å®¹å™¨ (`mkv`) æ˜¯å¦åœ¨ `video-preview.containers` ä¸­

å¦‚æœæ˜¯,ç»§ç»­è·å–è½¬ç ä¿¡æ¯ã€‚

**ç¬¬ 6 æ­¥: è·å–è½¬ç ä¿¡æ¯**

å¹¶å‘è¯·æ±‚å¤šä¸ªæ¸…æ™°åº¦çš„è½¬ç ä¿¡æ¯:

```go
// ä¼ªä»£ç 
go fetchPreview("/ç”µå½±/æ˜Ÿé™…ç©¿è¶Š.mkv", "FHD")  // 1080p
go fetchPreview("/ç”µå½±/æ˜Ÿé™…ç©¿è¶Š.mkv", "HD")   // 720p
go fetchPreview("/ç”µå½±/æ˜Ÿé™…ç©¿è¶Š.mkv", "SD")   // 480p
```

**ç¬¬ 7 æ­¥: æ„é€ æ–°çš„ MediaSource**

ä¸ºæ¯ä¸ªè½¬ç ç‰ˆæœ¬åˆ›å»ºä¸€ä¸ªæ–°çš„ `MediaSource`:

```go
newMediaSource := {
    Id: "12345[[_]]FHD[[_]]m3u8[[_]]/ç”µå½±/æ˜Ÿé™…ç©¿è¶Š.mkv",
    Name: "æ˜Ÿé™…ç©¿è¶Š - FHD (è½¬ç )",
    Container: "m3u8",
    Path: "/ç”µå½±/æ˜Ÿé™…ç©¿è¶Š.mkv",
    ...
}
```

**æ³¨æ„ Id æ ¼å¼**: ä½¿ç”¨ `[[_]]` åˆ†éš”ç¬¦ç¼–ç äº†:
- åŸå§‹ MediaSource Id
- è½¬ç æ¨¡æ¿ Id (FHD/HD/SD)
- å®¹å™¨æ ¼å¼ (m3u8)
- Openlist è·¯å¾„

**ç¬¬ 8 æ­¥: ä¿®æ”¹ PlaybackInfo**

```json
{
  "MediaSources": [
    { "Id": "12345", "Name": "åŸç”»", ... },
    { "Id": "12345[[_]]FHD[[_]]m3u8[[_]]...", "Name": "FHD", ... },
    { "Id": "12345[[_]]HD[[_]]m3u8[[_]]...", "Name": "HD", ... },
    { "Id": "12345[[_]]SD[[_]]m3u8[[_]]...", "Name": "SD", ... }
  ],
  "DirectPlayProfiles": [...]  // è®©å®¢æˆ·ç«¯ç›´æ¥æ’­æ”¾
}
```

**ç¬¬ 9 æ­¥: ç¼“å­˜å¹¶è¿”å›**

ç¼“å­˜è¿™ä¸ªå“åº” (12 å°æ—¶),è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

**ç¬¬ 10 æ­¥: ç”¨æˆ·é€‰æ‹©ç‰ˆæœ¬**

å®¢æˆ·ç«¯æ˜¾ç¤ºç‰ˆæœ¬é€‰æ‹©åˆ—è¡¨,ç”¨æˆ·é€‰æ‹© "FHD"ã€‚

**ç¬¬ 11 æ­¥: å®¢æˆ·ç«¯è¯·æ±‚è§†é¢‘æµ**

```
GET /emby/Videos/12345/stream.m3u8?MediaSourceId=12345[[_]]FHD[[_]]m3u8[[_]]...&api_key=xxx
```

**ç¬¬ 12 æ­¥: ç¨‹åºè§£æ MediaSourceId**

ä» `MediaSourceId` ä¸­æå–ä¿¡æ¯:
- è½¬ç æ¨¡æ¿: `FHD`
- å®¹å™¨æ ¼å¼: `m3u8`
- Openlist è·¯å¾„: `/ç”µå½±/æ˜Ÿé™…ç©¿è¶Š.mkv`

**ç¬¬ 13 æ­¥: è·å– m3u8 æ’­æ”¾åˆ—è¡¨**

å‘ Openlist è¯·æ±‚è½¬ç ç›´é“¾,å¾—åˆ° m3u8 æ’­æ”¾åˆ—è¡¨ URL,ä¸‹è½½å¹¶ä¿å­˜åˆ°å†…å­˜ã€‚

**ç¬¬ 14 æ­¥: è¿”å› m3u8 å†…å®¹**

å°†æ’­æ”¾åˆ—è¡¨ä¸­çš„ ts åˆ†ç‰‡ URL æ›¿æ¢ä¸ºæœ¬é¡¹ç›®çš„ URL:

```m3u8
#EXTM3U
#EXT-X-VERSION:3
#EXTINF:10.0,
http://ä½ çš„åä»£åœ°å€:8095/emby-m3u8/xxxxx/seg-0.ts
#EXTINF:10.0,
http://ä½ çš„åä»£åœ°å€:8095/emby-m3u8/xxxxx/seg-1.ts
...
```

**ç¬¬ 15 æ­¥: å®¢æˆ·ç«¯è¯·æ±‚ ts åˆ†ç‰‡**

```
GET /emby-m3u8/xxxxx/seg-0.ts
```

**ç¬¬ 16 æ­¥: ç¨‹åºé‡å®šå‘åˆ° ts ç›´é“¾**

ä»å†…å­˜ä¸­çš„æ’­æ”¾åˆ—è¡¨æ‰¾åˆ°è¿™ä¸ªåˆ†ç‰‡çš„ç›´é“¾,è¿”å› 302 é‡å®šå‘ã€‚

**ç¬¬ 17 æ­¥: å®¢æˆ·ç«¯ç›´è¿ç½‘ç›˜ä¸‹è½½**

å®¢æˆ·ç«¯ç›´æ¥ä»é˜¿é‡Œäº‘ç›˜ä¸‹è½½ ts åˆ†ç‰‡,ä¸ç»è¿‡æœåŠ¡å™¨ã€‚

**æ•´ä¸ªæµç¨‹æ€»ç»“**:

1. è·å–æ’­æ”¾ä¿¡æ¯ â†’ ç¼“å­˜ 12 å°æ—¶
2. è·å– m3u8 åˆ—è¡¨ â†’ ç¼“å­˜åœ¨å†…å­˜
3. è·å– ts ç›´é“¾ â†’ 302 é‡å®šå‘
4. å®¢æˆ·ç«¯ç›´è¿ä¸‹è½½ â†’ ä¸æ¶ˆè€—æœåŠ¡å™¨æµé‡

---

### å­—å¹•å¤„ç†æµç¨‹

#### åœºæ™¯: ç”¨æˆ·æ’­æ”¾å¸¦å†…åµŒå­—å¹•çš„è§†é¢‘

**ç¬¬ 1 æ­¥: å®¢æˆ·ç«¯è¯·æ±‚å­—å¹•åˆ—è¡¨**

Emby å®¢æˆ·ç«¯ä¼šå…ˆè¯·æ±‚è§†é¢‘çš„å…ƒæ•°æ®,å…¶ä¸­åŒ…å«å­—å¹•æµä¿¡æ¯ã€‚

**ç¬¬ 2 æ­¥: å®¢æˆ·ç«¯é€‰æ‹©å­—å¹•**

ç”¨æˆ·é€‰æ‹© "ä¸­æ–‡å­—å¹•",å®¢æˆ·ç«¯è¯·æ±‚:

```
GET /emby/Videos/12345/Subtitles/2/0/Stream.srt?api_key=xxx
```

**ç¬¬ 3 æ­¥: ç¨‹åºæ‹¦æˆªå­—å¹•è¯·æ±‚**

è·¯ç”±åŒ¹é…åˆ° `constant.Reg_VideoSubtitles`,è°ƒç”¨ `emby.ProxySubtitles` å¤„ç†ã€‚

**ç¬¬ 4 æ­¥: ä»£ç†åˆ°æºæœåŠ¡å™¨**

ç¨‹åºå‘ Emby æºæœåŠ¡å™¨è¯·æ±‚å­—å¹•:

```
GET http://embyæºåœ°å€:8096/emby/Videos/12345/Subtitles/2/0/Stream.srt?api_key=xxx
```

**ç¬¬ 5 æ­¥: Emby æå–å­—å¹•**

Emby æœåŠ¡å™¨ä¼š:
1. ä»æŒ‚è½½çš„ç½‘ç›˜æ–‡ä»¶è¯»å–è§†é¢‘
2. è°ƒç”¨ FFmpeg æå–å†…åµŒå­—å¹•
3. è½¬æ¢ä¸º SRT æ ¼å¼

**è¿™ä¸€æ­¥ä¼šæ¶ˆè€—æœåŠ¡å™¨æµé‡!**

**ç¬¬ 6 æ­¥: ç¼“å­˜å­—å¹•**

ç¨‹åºç¼“å­˜å­—å¹•å†…å®¹ (30 å¤©),ä¸‹æ¬¡è¯·æ±‚ç›´æ¥ä»ç¼“å­˜è¿”å›ã€‚

**ç¬¬ 7 æ­¥: è¿”å›å­—å¹•**

å°†å­—å¹•å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

**ä¼˜åŒ–å»ºè®®**:

å­—å¹•é¦–æ¬¡åŠ è½½å¯èƒ½å¾ˆæ…¢ (éœ€è¦ä¸‹è½½æ•´ä¸ªè§†é¢‘æ–‡ä»¶),å»ºè®®:
1. ä½¿ç”¨å¤–æŒ‚å­—å¹• (å•ç‹¬çš„ .srt æ–‡ä»¶)
2. æˆ–ä½¿ç”¨æ”¯æŒå¤–éƒ¨å­—å¹•çš„æ’­æ”¾å™¨ (å¦‚ MX Player)

---

### OSS ç›´é“¾æ¨¡å¼æµç¨‹

#### åœºæ™¯: åª’ä½“æ–‡ä»¶å­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨ (S3/OSS/COS)

**é…ç½®**:

```yaml
oss:
  enable: true
  endpoint: https://s3.example.com
  bucket: my-media
  path-mapping:
    - /movie:/movies
  cdn-auth:
    enable: true
    private-key: "your-secret-key"
    ttl: 3600
```

**ç¬¬ 1 æ­¥: å®¢æˆ·ç«¯è¯·æ±‚è§†é¢‘**

```
GET /emby/Videos/12345/stream?api_key=xxx
```

**ç¬¬ 2 æ­¥: è·å–åª’ä½“è·¯å¾„**

ä» Emby è·å–æœ¬åœ°è·¯å¾„:

```
/movie/æ˜Ÿé™…ç©¿è¶Š.mkv
```

**ç¬¬ 3 æ­¥: è·¯å¾„æ˜ å°„**

æ ¹æ®é…ç½®æ˜ å°„:

```
/movie/æ˜Ÿé™…ç©¿è¶Š.mkv â†’ /movies/æ˜Ÿé™…ç©¿è¶Š.mkv
```

**ç¬¬ 4 æ­¥: æ„é€  OSS URL**

```
https://s3.example.com/my-bucket/movies/æ˜Ÿé™…ç©¿è¶Š.mkv
```

**ç¬¬ 5 æ­¥: ç”Ÿæˆ CDN é‰´æƒç­¾å**

ä½¿ç”¨ Type-A ç®—æ³•:

```
timestamp = å½“å‰æ—¶é—´ + 3600ç§’
rand = éšæœº UUID
uid = 0
sstring = "/movies/æ˜Ÿé™…ç©¿è¶Š.mkv-{timestamp}-{rand}-{uid}-{private-key}"
md5hash = MD5(sstring)
auth_key = "{timestamp}-{rand}-{uid}-{md5hash}"
```

**ç¬¬ 6 æ­¥: æ·»åŠ é‰´æƒå‚æ•°**

```
https://s3.example.com/my-bucket/movies/æ˜Ÿé™…ç©¿è¶Š.mkv?auth_key=1734567890-abc123-0-def456
```

**ç¬¬ 7 æ­¥: 302 é‡å®šå‘**

```http
HTTP/1.1 302 Temporary Redirect
Location: https://s3.example.com/my-bucket/movies/æ˜Ÿé™…ç©¿è¶Š.mkv?auth_key=...
X-Api-Key: your-api-key
```

**ç¬¬ 8 æ­¥: å®¢æˆ·ç«¯ç›´è¿ OSS**

å®¢æˆ·ç«¯ç›´æ¥ä»å¯¹è±¡å­˜å‚¨ä¸‹è½½è§†é¢‘ã€‚

**OSS æ¨¡å¼ vs Openlist æ¨¡å¼**:

| ç‰¹æ€§ | Openlist | OSS |
|------|----------|-----|
| é€‚ç”¨åœºæ™¯ | ç½‘ç›˜æ–‡ä»¶ | å¯¹è±¡å­˜å‚¨æ–‡ä»¶ |
| è½¬ç æ”¯æŒ | âœ… | âŒ |
| ä¸­è½¬æœåŠ¡ | éœ€è¦ Openlist | ä¸éœ€è¦ |
| é‰´æƒæ–¹å¼ | Openlist Token | CDN Type-A |

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘å¤„ç†

Go è¯­è¨€å¤©ç”Ÿæ”¯æŒé«˜å¹¶å‘,ç¨‹åºå……åˆ†åˆ©ç”¨äº†è¿™ä¸€ç‰¹æ€§ã€‚

**ç¤ºä¾‹: è·å–è½¬ç ä¿¡æ¯**

å½“éœ€è¦è·å–å¤šä¸ªæ¸…æ™°åº¦çš„è½¬ç ä¿¡æ¯æ—¶,ç¨‹åºä¼šå¹¶å‘è¯·æ±‚:

```go
// ä¼ªä»£ç 
var wg sync.WaitGroup
results := make(chan PreviewInfo, 3)

for _, templateId := range []string{"FHD", "HD", "SD"} {
    wg.Add(1)
    go func(tid string) {
        defer wg.Done()
        result := fetchPreview(path, tid)
        results <- result
    }(templateId)
}

wg.Wait()
close(results)
```

3 ä¸ªè¯·æ±‚å¹¶å‘æ‰§è¡Œ,æ€»è€—æ—¶ = å•æ¬¡è¯·æ±‚è€—æ—¶ (è€Œä¸æ˜¯ 3 å€)ã€‚

### 2. å• Goroutine ç»´æŠ¤

æŸäº›æ•°æ®ç»“æ„ä½¿ç”¨**å•ä¸ª goroutine** ç»´æŠ¤,é¿å…é”ç«äº‰ã€‚

**M3U8 æ’­æ”¾åˆ—è¡¨ç®¡ç†**:

```go
// ä¼ªä»£ç 
type M3U8Manager struct {
    playlists map[string]*Playlist  // ä¸éœ€è¦åŠ é”!
    requests  chan Request           // è¯·æ±‚é€šé“
}

func (m *M3U8Manager) Run() {
    for req := range m.requests {
        // å•çº¿ç¨‹å¤„ç†,ä¸ä¼šæœ‰ç«æ€
        m.handleRequest(req)
    }
}
```

**ä¼˜ç‚¹**:
- æ— éœ€åŠ é”,æ€§èƒ½æ›´å¥½
- é€»è¾‘ç®€å•,ä¸ä¼šå‡ºç°æ­»é”
- å®¹æ˜“å®ç° LRU ç­‰å¤æ‚ç­–ç•¥

### 3. sync.Map æ— é”ç¼“å­˜

å¯¹äºè¯»å¤šå†™å°‘çš„åœºæ™¯,ä½¿ç”¨ `sync.Map` ä»£æ›¿æ™®é€š map + é”ã€‚

**API Key ç¼“å­˜**:

```go
var apiKeyCache sync.Map

// å†™å…¥
apiKeyCache.Store(apiKey, true)

// è¯»å–
if _, ok := apiKeyCache.Load(apiKey); ok {
    // Key æœ‰æ•ˆ
}
```

`sync.Map` é’ˆå¯¹ä»¥ä¸‹åœºæ™¯ä¼˜åŒ–:
- è¯»å¤šå†™å°‘
- ä¸åŒ key ç”±ä¸åŒ goroutine å¤„ç†

**æ€§èƒ½å¯¹æ¯”**:

```
æ™®é€š map + RWMutex:  100 ä¸‡æ¬¡è¯»å– ~50ms
sync.Map:            100 ä¸‡æ¬¡è¯»å– ~20ms
```

### 4. ç¼“å­˜ç­–ç•¥

**å¤šçº§ç¼“å­˜**:

1. **å†…å­˜ç¼“å­˜**: å“åº”å†…å®¹ç¼“å­˜åœ¨å†…å­˜ä¸­
2. **API Key ç¼“å­˜**: é¿å…é‡å¤éªŒè¯
3. **Openlist ç›´é“¾ç¼“å­˜**: 10 åˆ†é’Ÿ
4. **PlaybackInfo ç¼“å­˜**: 12 å°æ—¶

**ç¼“å­˜é¢„çƒ­**:

ç¨‹åºä½¿ç”¨**é¢„ç¼“å­˜é€šé“**å¼‚æ­¥ç”Ÿæˆç¼“å­˜:

```go
// ä¼ªä»£ç 
cacheRequestChan := make(chan CacheRequest, 1000)

// è¯·æ±‚å¤„ç†å™¨
func handleRequest(c *gin.Context) {
    // ç«‹å³è¿”å›å“åº”
    c.JSON(200, response)

    // å¼‚æ­¥é¢„ç¼“å­˜ç›¸å…³æ•°æ®
    cacheRequestChan <- CacheRequest{...}
}

// åå°ç¼“å­˜ç”Ÿæˆå™¨
func cacheWorker() {
    for req := range cacheRequestChan {
        generateCache(req)
    }
}
```

### 5. æ­£åˆ™è¡¨è¾¾å¼é¢„ç¼–è¯‘

æ‰€æœ‰è·¯ç”±æ­£åˆ™è¡¨è¾¾å¼åœ¨å¯åŠ¨æ—¶é¢„ç¼–è¯‘:

```go
// å¯åŠ¨æ—¶
var compiledRegex = regexp.MustCompile(pattern)

// è¿è¡Œæ—¶ (å¿«é€Ÿ)
if compiledRegex.MatchString(uri) {
    // åŒ¹é…æˆåŠŸ
}
```

**æ€§èƒ½å¯¹æ¯”**:

```
æ¯æ¬¡ç¼–è¯‘æ­£åˆ™:  1000 æ¬¡åŒ¹é… ~100ms
é¢„ç¼–è¯‘æ­£åˆ™:    1000 æ¬¡åŒ¹é… ~1ms
```

### 6. è¿æ¥æ± å¤ç”¨

HTTP å®¢æˆ·ç«¯ä½¿ç”¨è¿æ¥æ± ,é¿å…é¢‘ç¹å»ºç«‹è¿æ¥:

```go
var httpClient = &http.Client{
    Transport: &http.Transport{
        MaxIdleConns:        100,
        MaxIdleConnsPerHost: 10,
        IdleConnTimeout:     90 * time.Second,
    },
}
```

**ä¼˜ç‚¹**:
- å‡å°‘ TCP æ¡æ‰‹å¼€é”€
- é™ä½å»¶è¿Ÿ
- æé«˜ååé‡

---

## é…ç½®ç³»ç»Ÿ

### é…ç½®åŠ è½½æµç¨‹

```
è¯»å– config.yml â†’ YAML è§£æ â†’ ç»“æ„ä½“ååºåˆ—åŒ– â†’ åå°„åˆå§‹åŒ– â†’ çº§è”è°ƒç”¨ Init()
```

**æ‰€æœ‰é…ç½®ç»“æ„ä½“éƒ½å®ç°**:

```go
type Initializer interface {
    Init() error  // éªŒè¯å’Œåˆå§‹åŒ–
}
```

**ç¤ºä¾‹**:

```go
type EmbyConfig struct {
    Host      string `yaml:"host"`
    MountPath string `yaml:"mount-path"`
}

func (c *EmbyConfig) Init() error {
    if c.Host == "" {
        return errors.New("emby.host ä¸èƒ½ä¸ºç©º")
    }

    // æ ‡å‡†åŒ– URL
    c.Host = strings.TrimSuffix(c.Host, "/")

    return nil
}
```

**é…ç½®éªŒè¯**:

ç¨‹åºå¯åŠ¨æ—¶ä¼šéªŒè¯æ‰€æœ‰é…ç½®:
- å¿…å¡«é¡¹æ£€æŸ¥
- æ ¼å¼éªŒè¯
- ä¾èµ–æ£€æŸ¥ (å¦‚å¯ç”¨ OSS æ—¶å¿…é¡»é…ç½® endpoint)

å¦‚æœé…ç½®é”™è¯¯,ç¨‹åºä¼šç«‹å³é€€å‡ºå¹¶æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚

### è·¯å¾„æ˜ å°„é…ç½®è¯¦è§£

è¿™æ˜¯æœ€å®¹æ˜“é…ç½®é”™è¯¯çš„åœ°æ–¹,éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚

**ç¤ºä¾‹åœºæ™¯**:

- Emby å®¹å™¨å†…æŒ‚è½½è·¯å¾„: `/data/movie`
- Openlist è·¯å¾„: `/ç”µå½±`
- æœ¬åœ°å®é™…è·¯å¾„ (å®¿ä¸»æœº): `/mnt/clouddrive/ç”µå½±`

**é…ç½®**:

```yaml
emby:
  mount-path: /data  # Emby å®¹å™¨å†…çš„æŒ‚è½½æ ¹è·¯å¾„

path:
  emby2openlist:
    - /data/movie:/ç”µå½±  # å‰ç¼€æ˜ å°„
```

**è½¬æ¢è¿‡ç¨‹**:

```
Emby åª’ä½“è·¯å¾„: /data/movie/æ˜Ÿé™…ç©¿è¶Š/æ˜Ÿé™…ç©¿è¶Š.mkv
              â†“ åŒ¹é…å‰ç¼€ /data/movie
              â†“ ç§»é™¤å‰ç¼€
              æ˜Ÿé™…ç©¿è¶Š/æ˜Ÿé™…ç©¿è¶Š.mkv
              â†“ æ·»åŠ  Openlist å‰ç¼€ /ç”µå½±
Openlist è·¯å¾„: /ç”µå½±/æ˜Ÿé™…ç©¿è¶Š/æ˜Ÿé™…ç©¿è¶Š.mkv
```

**å¸¸è§é”™è¯¯**:

âŒ **é”™è¯¯ 1: å‰ç¼€ä¸åŒ¹é…**

```yaml
emby:
  mount-path: /mnt/data  # é”™è¯¯,è¿™æ˜¯å®¿ä¸»æœºè·¯å¾„

path:
  emby2openlist:
    - /mnt/data/movie:/ç”µå½±
```

Emby è¿”å›çš„è·¯å¾„æ˜¯å®¹å™¨å†…è·¯å¾„ `/data/movie/xxx`,ä¸æ˜¯ `/mnt/data/movie/xxx`ã€‚

âœ… **æ­£ç¡®é…ç½®**:

```yaml
emby:
  mount-path: /data  # Emby å®¹å™¨å†…è·¯å¾„

path:
  emby2openlist:
    - /data/movie:/ç”µå½±
```

âŒ **é”™è¯¯ 2: æ˜ å°„æ–¹å‘é”™è¯¯**

```yaml
path:
  emby2openlist:
    - /ç”µå½±:/data/movie  # åäº†!
```

æ ¼å¼æ˜¯ `Embyè·¯å¾„:Openlistè·¯å¾„`,ä¸æ˜¯åè¿‡æ¥ã€‚

---

## æ€»ç»“

go-emby2openlist é€šè¿‡ä»¥ä¸‹æŠ€æœ¯å®ç°é«˜æ•ˆçš„ç½‘ç›˜ç›´é“¾æ’­æ”¾:

1. **åå‘ä»£ç†**: æ‹¦æˆª Emby API,æ³¨å…¥ç›´é“¾ä¿¡æ¯
2. **è·¯å¾„æ˜ å°„**: æ™ºèƒ½è½¬æ¢ Emby è·¯å¾„åˆ°ç½‘ç›˜è·¯å¾„
3. **å¤šçº§ç¼“å­˜**: å‡å°‘é‡å¤è¯·æ±‚,æå‡å“åº”é€Ÿåº¦
4. **å¹¶å‘ä¼˜åŒ–**: å……åˆ†åˆ©ç”¨ Go è¯­è¨€çš„å¹¶å‘ç‰¹æ€§
5. **å†…å­˜ç®¡ç†**: å• goroutine ç»´æŠ¤,LRU æ·˜æ±°ç­–ç•¥
6. **è½¬ç æ”¯æŒ**: åŠ¨æ€æ·»åŠ è½¬ç ç‰ˆæœ¬åˆ°æ’­æ”¾åˆ—è¡¨

**æ ¸å¿ƒä¼˜åŠ¿**:

- âœ… **ä¸æ¶ˆè€—æœåŠ¡å™¨å¸¦å®½**: è§†é¢‘ç›´æ¥ä»ç½‘ç›˜ä¸‹è½½
- âœ… **æ’­æ”¾é€Ÿåº¦å¿«**: å—é™äºç½‘ç›˜ä¼šå‘˜é€Ÿåº¦,è€ŒéæœåŠ¡å™¨å¸¦å®½
- âœ… **æœåŠ¡å™¨å‹åŠ›å°**: åªå¤„ç†å°‘é‡ API è¯·æ±‚
- âœ… **æ”¯æŒè½¬ç **: é˜¿é‡Œäº‘ç›˜è½¬ç ç›´é“¾,ä½é€Ÿç‡ä¹Ÿèƒ½æµç•…æ’­æ”¾
- âœ… **æ˜“äºéƒ¨ç½²**: Docker ä¸€é”®éƒ¨ç½²,é…ç½®ç®€å•

**æŠ€æœ¯äº®ç‚¹**:

- ğŸš€ **é«˜æ€§èƒ½**: Go è¯­è¨€ + Gin æ¡†æ¶,å¹¶å‘æ€§èƒ½ä¼˜ç§€
- ğŸ§  **æ™ºèƒ½ç¼“å­˜**: å¤šçº§ç¼“å­˜ç­–ç•¥,å‡å°‘ç½‘ç»œè¯·æ±‚
- ğŸ”§ **çµæ´»é…ç½®**: YAML é…ç½®,æ”¯æŒå¤šç§åœºæ™¯
- ğŸ›¡ï¸ **ç¨³å®šå¯é **: è‡ªåŠ¨å›é€€,é”™è¯¯å¤„ç†å®Œå–„

å¸Œæœ›è¿™ç¯‡æ–‡æ¡£èƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£ go-emby2openlist çš„å·¥ä½œåŸç†!
